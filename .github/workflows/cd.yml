name: CD

# Event Triggers
on:
    # Trigger CD when CI workflow is completed
    workflow_run:
        workflows: ["CI"]
        types: ["completed"]

jobs:
    # Deploy Job
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest

        # Grant read permission to the actions scope for this job
        permissions:
            actions: read

        steps:
            # Download build artifact from CI workflow
            - name: Download build artifact
              uses: actions/download-artifact@v4
              with:
                  name: deploy
                  path: deploy
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  repository: ${{ github.repository }}
                  run-id: ${{ github.event.workflow_run.id }}

            # Install Netlify CLI
            - name: Install Netlify CLI
              run: npm install -g netlify-cli

            # List artifact files (debug)
            - name: List artifact files (debug)
              run: |
                ls -la deploy
                ls -la deploy/dist | head -n 40
                ls -la deploy/netlify | head -n 40
            
            # Deploy to Netlify
            - name: Deploy to Netlify
              env:
                  NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
                  PROD_SITE: ${{ secrets.NETLIFY_SITE_ID }}
                  BETA_SITE: ${{ secrets.BETA_NETLIFY_SITE_ID }}
              run: |
                  BRANCH="${{ github.event.workflow_run.head_branch }}"
                  echo "Deploying branch: " $BRANCH

                  cd deploy

                  if [ "$BRANCH" = "master" ]; then
                      echo "Deploying to PRODUCTION..."
                      netlify deploy \
                      --dir=dist \
                      --site=$PROD_SITE \
                      --auth=$NETLIFY_AUTH_TOKEN \
                      --prod

                  else
                      echo "Deploying to BETA..."
                      netlify deploy \
                      --dir=dist \
                      --site=$BETA_SITE \
                      --auth=$NETLIFY_AUTH_TOKEN \
                      --prod
                  fi
